= 日志易租户管理手册
北京优特捷信息技术有限公司
v4.1, 2021-11-09
:encoding: utf-8
:lang: en
:toc: left
:toclevels: 4
:toc-title:
:back-cover-image: image:resources/bckcover.jpg[]
:stylesheet: resources/css/yottastyle.css
:numbered:

== 多租户平台概述

日志易天然的提供多租户平台的服务形式，并以多租户平台的形式运行维护日志易公有云和私有云服务。第三方企业用户，或集团用户的子公司，均可以作为平台上的一个租户独立存在。

每个具体的使用者账户，及其输入的数据、创建的资源配置，都归属在对应的租户系统内部。租户之间数据相互隔离，租户与平台之间同样相互隔离。日志易平台的维护者，并不介入租户内部。

== 使用管理平台

=== 管理员登录

在日志易产品部署完成后，浏览器地址栏输入 `http://<YOTTAWEB-IP>/domain/tenant/`，即可打开租户管理平台的登录页面：

image::images/tenant-login.png[]

管理平台的默认用户名是： `admin` ，密码是： `admin@rizhiyi.com` 。

成功登录后，你可以点击页面右上角的用户图标，进入"用户信息"页面，并修改管理员账户和接收邮箱。

由于租户管理的高危性，请务必修改管理员密码。在登录界面点击"忘记密码"后，日志易将向管理员的接收邮箱发送一封重置密码邮件。点击邮件中的临时地址，进行密码修改。

=== 系统状态

租户管理平台上，可以查看整个日志易集群的总数据量使用状态，以及许可证池的特性详情清单。这是租户管理的基础。

image::images/tenant-system.png[]

== 租户管理

租户管理平台上，可以创建、编辑和查看租户。租户列表页默认展示租户的名称和过去一个月的数据用量。您可以点击展开，查看该租户被授予的每日限额、有效期和特性许可。

image::images/tenant-list.png[]

=== 创建租户

租户列表右上角点击"新建"，开始创建一个新的租户。界面如下：

image::images/create-tenant.png[]

可以填写或选择的内容包括：

* 名称：在租户列表上展示的名称。
* 域名：在系统中用来标识租户的唯一标识符。一经设置，不可变更。在其他使用手册里通常用 domain 来称呼。
* 支持特性：可以在系统状态中所支持的全部特性中选择任意多个特性，授予该租户。
* 每日限额：可以在系统状态中所支持的总限额之内，授予该用户指定的限额大小。日志易并不限制您所创建的全部租户的限额之和要小于等于总限额。当平台上只有日志易内置的 ops 和 self 两个租户时，平台会自动设置内置租户的每日限额为当前 license 的总限额。
* 超限次数：可以设置在最近一个月中，最多允许超过几次每日限额。
* 超额行为：当触发超限次数阈值后，采取何种处理。
** 拒绝采集输入：在数据接收层丢弃掉发送过来的数据。依赖于数据发送层主动阻塞并停止采集来保障数据安全。这种行为对平台稳定性有益。其中在存储资源有限的条件下为保障核心日志不受影响，可以配置"丢弃规则"。
*** 丢弃规则默认不开启
*** 限额使用配置：超过每日限额的百分比后，将不执行采集输入，默认95%
*** 通过source、appname、tag定义丢弃条件，三项至少填写一项且AND关系，若不填写默认为"*"，填写多个字段时会当做一个值处理，例如tag填写"nginx,tomcat"，丢弃日志的字段会精确匹配到{"tag":["nginx", "tomcat"], "raw_message":"2023-10-10 10:10:12,827 INFO sink-pool-0-1 XXXX"}，匹配不到{"tag":nginx, "raw_message":"XXXX"}，{"tag":tomcat, "raw_message":" XXXX"}，，这里可以定义多条丢弃规则来实现
*** 可以定义多组规则，多组规则OR关系，先达到限额百分比，先拒绝采集日志

image::images/tenant_refuse_lostrule.png[]
   
** 接收采集拒绝查询：数据接入流程无变化，但拒绝用户通过页面和 API 进行任何登录、查询、管理操作。这种行为对业务数据安全有益。
* 管理员名称：在租户内部拥有管理员权限的账户
* 管理员邮箱：在租户内部拥有管理员权限的账户的邮箱
* 管理员密码：在租户内部拥有管理员权限的账户的密码

租户创建完成后，该租户的管理员可以访问 "http://<YOTTAWEB-IP>" 地址，采用邮箱和密码登录，并进行租户内部的数据管理、用户管理等操作。

[NOTE]
====
租户的管理员设置仅在创建流程中有效。租户一经创建，其内部管理员权限的移交就依赖于该用户自己的操作。租户管理平台本身并不窥视租户内部的用户数据，也就无法提供用户列表供选择修改。

如果租户内部有其他用户账号也拥有 \__admin__ 角色权限，租户管理页也将展示出这些账号的信息。
====

[NOTE]
====
当日志易集群磁盘空间不足时，也可能导致数据接收层拒绝采集输入。

当 beaver 模块的磁盘空间占用率超过 auth 模块配置项 `min_reserved_avail_disk_ratio`，或 beaver 临时挂机维护时，日志易还将继续维持数据接收一段时间，这段时间内，接收数据将暂存在 kafka 模块的磁盘队列中。如果想调整这个时间，请修改日志易 Manager 中 auth 模块的配置项：`out_if_disk_timeout_in_min`，默认为 60 分钟。
====

租户内角色权限的操作细节，请参阅《日志易使用手册》中"用户管理"相关章节。

== Agent 升级/安装包管理

日志易 Agent 的升级/安装包，在整个日志易平台上全局可用，故而在租户管理页面上统一维护。租户内部只需要选择具体某个版本分发即可。

界面如下：

image::images/tenant-agent-upload.png[]

选择升级/安装包，确定上传。等待上传进度完成。上传完成后，新的升级/安装包版本随即就会展示上页面列表上。

如图所示，升级包有5个不同版本，分别是：

* 支持AIX/HPUX的*nix版本；
* 支持Linux的32位版本；
* 支持Linux的64位版本；
* 支持Windows的32位版本；
* 支持Linux的带有数据库读取功能的64位版本。

日志易 Agent 安装包大小可能超出部分环境内对页面上传文件的大小限制。因此，日志易也提供从服务器端完成包上传的程序。通过堡垒机将安装包预先上传到服务器端后，登录日志易 yottaweb 服务器，执行如下指令即可：

 python yottaweb/api/resources/domainsystem/uploadAgent.py --path=/data/heka-3_0_0.10-linux-386.tar.gz --username=admin --password=tenantpassword

目前界面升级仅支持相同序列的版本升级，如果需要交叉版本切换，请手工登录服务器完成替换工作。

== 租户外观

租户界面的大多数配置均可以在租户内部的系统设置中通过"外观"配置修改。只有登录页 Logo 图，在此处修改。Logo 图尺寸要求为 75px*30px；仅支持png格式，文件必须小于1M。点击"替换"，选择文件上传即可。

== 应用管理

租户平台的应用管理包含了系统应用和自定义应用，其中系统应用只能在租户平台完成授权操作，升级包和删除需要在manager管理系统完成。这里主要展开自定义应用包的操作。

== 服务管理

用户可以在服务管理页面配置LDAP接入，支持使用企业自身的 LDAP 账户和认证方式，登录日志易系统。

LDAP接入配置包含了四部分：LDAP连接配置、基础配置、过滤配置、属性映射配置。其中LDAP连接配置、基础配置、过滤配置是必填项，属性映射配置可根据需要设置。

首先，用户需要打开启用LDAP开关，开关默认是关闭状态。

LDAP连接配置参数及说明如下：

* 服务器地址：LDAP的服务器地址，支持域名和IP地址
* 端口：LDAP服务的端口号
* 加密方式：默认加密方式plain, 可选start_tls、ldaps。如果选择start_tls或者ldaps加密方式，还需要额外填写相关的证书路径
** CA证书(ca_cert_file)：填写CA证书的完整文件路径
** 私有证书(private_cert_file)：填写CA私有证书的完整文件路径，需要和 private_key_file 同时配置
** 私有锁文件(private_key_file)：填写CA证书的私钥路径，需要和 private_cert_file 同时配置
* 域信息：LDAP域信息，即查找范围，例如：`ou=People,dc=github,dc=com`。如果需要设置多个域查找范围，可以用分号`;`隔开，例如`ou=xxx,dc=github,dc=com;ou=yyy,dc=github,dc=com`
* LDAP管理员用户名称：输入LDAP管理员用户名
* LDAP管理员密码：输入LDAP管理员用户密码

image::images/ldap_config.png[]

和日志易平台有关的基础配置参数及说明如下：

* 日志易租户内管理员用户：准备采用LDAP对接的日志易租户，其租户内管理员用户的ID，默认推荐使用租户下的admin账号id。用户可以在"权限-用户管理"列表页查看对应 ID 值。
* 日志易租户ID：准备采用LDAP对接的日志易租户ID，用户可以查询数据库表获取。
* 数据集ID：LDAP用户登录搜索时，默认可用的数据集ID。数据集需要提前在租户内建立好，该参数填写`-1`代表全部数据集可用。

image::images/ldap-baseconfig.png[]

过滤配置参数及说明如下：

* 用户过滤条件：LDAP用户查询的过滤条件，例如：`(objectClass=*)`。当LDAP域内OU数据量过大时，可以填写用户过滤条件(user_filter)参数，主动减少对 LDAP 服务器的查询范围
* 用户过滤设置：该参数用于用户名登录时过滤单个用户，设置项对应在LDAP服务器上用户名的属性，一般是`cn`

image::images/ldap-fliterconfig.png[]

如果有更多的 LDAP 属性需要对接到日志易平台中，可以按需填写属性映射配置，配置参数及说明如下：

* 邮箱过滤设置：该参数用于邮箱登录时过滤单个用户，设置项对应在LDAP服务器上邮箱的属性，一般是`mail`
* 邮箱服务器地址：如果登录用户在LDAP域中mail字段为空，但日志易系统中email是必填项，所以日志易将使用用户名和本字段拼成该用户邮箱
* 用户归属用户组设置：LDAP用户初次登录，默认属于哪个用户分组。这里写的是用户分组ID，用户分组需要提前建立好。用户可以在"权限-用户分组"列表页查看对应 ID 值。
* 全用户名映射设置：将LDAP用户的全名，映射到日志易平台用户的全名(fullname)
* 手机映射设置：将LDAP用户的手机号，映射到日志易平台用户的电话号码(phone)
* 部门信息映射设置：LDAP中记录用户所属部门的字段名称。例如：`departmentNumber`
* 部门与日志易用户组关系映射配置：LDAP中记录的用户所属部门，与日志易中对应用户分组ID的映射关系，多分组ID用逗号`,`分割，多组映射关系用双竖线`||`分割。例如：`dba=4||mobile=2,4`表示：LDAP中dba部门的用户登录到日志易后，自动映射为日志易内分组ID为4的用户分组成员；mobile部门的用户自动映射为日志易内分组ID为2和4的用户分组成员；其他用户依然保留在用户归属用户组设置(default_user_group_id)指定的默认用户分组中。
+
注意：当启用LDAP控制用户分组，即填写了上面两项部门信息映射配置(group_attribute_name)和部门与日志易用户组关系映射配置(groups_mapping)后，在“权限->用户分组”做任何修改变更都是无效的。
+
* 分组用户登录设置：可限制LDAP用户中，仅允许属于上述映射分组的用户可登录日志易
* 用户名后缀：LDAP用户实际存储在日志易中的用户名后缀

image::images/ldap-attributeconfig.png[]

[NOTE]
====
1. 日志易v5.2升级兼容性问题说明
** 日志易早期版本的用户LDAP接入是通过manager配置项管理的，升级到 v5.2 版本时，租户管理功能里新增了服务管理LDAP配置页面，并且会通过升级脚本读取manager配置项，正常展示；
** 当用户进入租户管理页面，在LDAP配置表单中点击”保存”后，配置参数才会实际写入租户数据库。从此之后，服务管理配置表单跟manager配置项没有关系；
** 服务管理配置保存生效后，将成为用户LDAP配置的唯一入口，也就是说manager上的相关配置不再有效。因此，建议用户升级后改用服务管理配置页面。
2. 用户LDAP服务失败时，日志易admin用户依然可以正常登录，但其他LDAP对接生成的普通用户会受到影响。
====

=== 上传应用包

点击右上角的”上传“，这里仅支持自定义应用包的安装和升级，选择已制作的应用包或者从系统导出的应用包后，系统>会自动识别出当前的应用名称、系统标识。自定义应用安装完成后，需要以admin账户登录日志易系统去激活该应用。

image::images/tenant_app_upload.png[]

上传应用包，系统会根据应用uuid来判断是安装操作还是升级操作。应用uuid不存在为初始化安装，存在则为升级操作，升级操作要求版本号必须大于当前版本。

初次安装应用注意事项：

* 只有安装应用包，可修改应用名称和系统标识；
* 应用名称允许为中文、英文字母、数字、下划线_、短横线-，且不可以为纯数字；
* 系统标识允许为英文字母、数字、下划线_、短横线-，且不可以为纯数字；
* 应用名称不可以为日志易自身的名称default_search、系统应用名称（如：观察易lunaxee等）、其他日志易系统已占用的名称（如：yottaweb）,建议根据客户现场实际应用来命名；
* 新安装的应用默认授权给ops租户。

=== 升级应用包

image::images/tenant_app_update_upload.png[]

点击”继续安装“完成升级操作后，版本号会自动加1。

升级应用注意事项：

* 升级应用，不可以修改应用名称和系统标识；
* 升级应用版本号必须大于当前版本

=== 应用授权

初次安装的自定义应用默认授权ops租户，点击”授权“可回收或者授权到其他租户。

image::images/tenant_app_auth.png[]

=== 应用删除

点击”删除“，应用彻底从租户平台以及日志易平台删除。

